---
title: "cohCon_analyze"
output: html_document
---

```{r}
library(ggplot2)
library(dplyr)
library(tidyr)
library(lme4)
library(effects)
library(MASS)
```


```{r}

allThresh25 = getSubjThresholdPlot('behav','s025')
allThresh300 = getSubjThresholdPlot('behav','s300')

aT25 = cbind(allThresh25,subj='25')
aT300 = cbind(allThresh300,subj='300')

allThresh = rbind(aT25,aT300)

allT = allThresh %>%
  group_by(task,pedestal,catch) %>%
  mutate(muAcross = mean(mu),ciAcross = sd(mu)/sqrt(n())*1.96) %>%
  ungroup()
```

```{r}
# 
figFolder = '/Users/dan/proj/att_awe/analysis/figures/behav/'
# pdf(file=sprintf('%s/thresholdPlot_all.pdf',figFolder))
allT %>%
  mutate(pedVal=pedVal*100,mu=mu*100,ci=ci*100) %>%
  filter(subj==300) %>%
  ggplot(data=.) +
    geom_point(aes(pedVal,mu,color=task,linetype=catch),size=4) +
    geom_line(aes(pedVal,mu,color=task,linetype=catch),size=.5) +
    geom_errorbar(aes(pedVal,mu,color=task,linetype=catch,ymin=mu-ci,ymax=mu+ci),size=.5,width=0) +
    theme_bw() +
    ylab('80% Threshold') +
    xlab('Stimulus Contrast (%)') +
    scale_y_log10(breaks = trans_breaks("log10", function(x) round(10^x,0))) +
    scale_x_log10(breaks = trans_breaks("log10", function(x) round(10^x,0))) +
    annotation_logticks(scaled=T) +
    theme(text = element_text(size=15)) +
    scale_color_brewer(palette='Paired')
# dev.off()
```

```{r}
# Reaction time analysis
filesToLoad = 1:4

if (type=='behav') {
  anFolder = sprintf('/Users/dan/data/cohcon/%s/analysis/',subj)
  csvFolder = paste(anFolder,'csv/',sep="")
} else {
  anFolder = sprintf('/Users/dan/data/cohcon/scan2/%s/analysis/',subj)
  csvFolder = paste(anFolder,'csv/',sep="")
}
for (fi in filesToLoad) {
  # Dealing with run # fi
  main = read.csv(sprintf('%s/main%02.f.csv',csvFolder,fi))  
  # Switch to determine what kind of analysis we do
  main = main %>% 
    mutate(rTrial=(run-1)*150+trial)
  
  if (fi==1) {
    mdata = main
  } else {
    mdata = rbind(mdata,main)
  }
}

cdata = mdata %>%
  filter(isCatch==1)

mdata = mdata %>%
  mutate(congruent=(cohSide==conSide),correctF=factor(correct,levels=c(0,1),labels=c('Incorrect','Correct')),conSide=factor(conSide,levels=c(1,2),labels=c('Left','Right')),cohSide=factor(cohSide,levels=c(1,2),labels=c('Left','Right')),taskF=factor(task,levels=c(1,2),labels=c('Coherence','Contrast')),conPedestal=factor(conPedestal),cohPedestal=factor(cohPedestal),isCatch=factor(isCatch,levels=c(0,1),labels=c('Cued','Miscued')))

rs = lm(data=mdata,RT ~ correct + isCatch*congruent + task*conSide + task*cohSide)
```

```{r}
for (fi in filesToLoad) {
  # Dealing with run # fi
  eye = read.csv(sprintf('%s/eye%02.f.csv',csvFolder,fi))
  
  if (fi==1) {
    edata = eye
  } else {
    edata = rbind(edata,eye)
  }
}
```

```{r}
```

```{r}
rs = lm(data=mdata,RT~correct+isCatch)
mdata %>%
  ggplot(data=.,aes(correct,RT,color=isCatch)) +
  geom_point() +
  geom_smooth(method="lm")
```


```{r}
getSubjThresholdPlot = function(type,subj) {
  if (type=='behav') {
    anFolder = sprintf('/Users/dan/data/cohcon/%s/analysis/',subj)
    csvFolder = paste(anFolder,'csv/',sep="")
  } else {
    anFolder = sprintf('/Users/dan/data/cohcon/scan2/%s/analysis/',subj)
    csvFolder = paste(anFolder,'csv/',sep="")
  }
  figFolder = paste('/Users/dan/proj/att_awe/analysis/','figures/',type,sep="")
  mainTh = read.csv(sprintf('%smainThresholds.csv',csvFolder))
  catTh = read.csv(sprintf('%scatThresholds.csv',csvFolder))
  run = read.csv(sprintf('%srun04.csv',csvFolder))
  mainTh = mainTh %>%
    group_by(task,pedestal) %>%
    summarise(mu=mean(threshold),ci=sd(threshold)/sqrt(n())*1.96)
  main = left_join(mainTh,run)
  main = main %>%
    ungroup() %>%
    mutate(task=factor(task,levels=c(1,2),labels=c('Coherence','Contrast')))
  
  catTh = catTh %>%
    group_by(task,pedestal) %>%
    summarise(mu=mean(threshold),ci=sd(threshold)/sqrt(n())*1.96)
  cat = left_join(catTh,run)
  cat = cat %>%
    ungroup() %>%
    mutate(task=factor(task,levels=c(1,2),labels=c('Coherence','Contrast')))
  cat = cat %>%
    filter(mu < 5, mu > 0)
  fname=sprintf('%s/%s_th_task_catch.pdf',figFolder,subj)
  main = cbind(main,catch=0)
  cat = cbind(cat,catch=1)
  allThresh = rbind(main,cat)
  allThresh = mutate(allThresh,catch=factor(catch,levels=c(0,1),labels=c('Cued','Miscued')))
  g = ggplot(data=allThresh,aes(task,mu,fill=catch)) +
    geom_bar(position="dodge",width=.75,stat="identity") +
    geom_errorbar(aes(ymin=mu-ci,ymax=mu+ci),position=position_dodge(width=.75),width=0) +
    theme_bw() +
    scale_fill_brewer() +
    theme(text = element_text(size=20)) +
    xlab('Pedestal Value (%)') +
    ylab('Discrimination Threshold')
  ggsave(filename=fname,plot=g)
  return(allThresh)
}
```
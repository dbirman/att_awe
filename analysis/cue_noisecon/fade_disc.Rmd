---
title: "fade_disc"
author: Dan Birman
date: "January 22, 2015"
output: html_document
---

Loading some important stuff

```{r}
library(ggplot2)
library(dplyr)
library(tidyr)
library(lme4)
```

Loading the data files

```{r}
main = read.csv('/Users/dan/data/cue_fade/s300/analysis/csv/mainThresholds.csv')
# catch = read.csv('/Users/dan/data/cue_fade/s300/analysis/csv/catchThresholds.csv')
run = read.csv('/Users/dan/data/cue_fade/s300/analysis/csv/run01.csv')
```

Cleaning up the run

```{r}
contrast = c(run[1,1],run[1,2],run[1,3])
```

```{r cleanup}
main = main %>%
  mutate(taskf = factor(task,levels=c(1,2),labels=c('Contrast','Noise')),
         cuesf = factor(cues,levels=c(1,2),labels=c('One','Four')),
         pedf = factor(pedestal,levels=c(1,2,3),labels=contrast))
mainmean = main %>% 
  group_by(taskf,pedestal,cuesf) %>% 
  summarise(mu=mean(threshold),sd=sd(threshold))
mainmean = mainmean %>% mutate(muround=round(mu,2))
```

```{r}
main %>%
  ggplot(data=.) +
  geom_line(aes(pedestal,threshold,color=taskf,linetype=cuesf)) +
  geom_errorbar(data=mainmean,aes(pedestal,mu,ymin=mu-sd,ymax=mu+sd,color=taskf,linetype=cuesf)) +
  theme_bw()
```




Now let's add the pedestal values for noise and contrast into the data.frame, this is a bit of a pain and unfortunately I don't know a better solution.
```{r}
pedFrame = data.frame(taskf=c('Noise','Noise','Noise',
                   'Contrast','Contrast','Contrast'),
           pedestal=c(1,2,3,
                      1,2,3),
           pedValue=c(noisePed,
                          contrastPed))
main = main %>% merge(pedFrame)
main = main %>%
  mutate(imgFile = ifelse(taskf=='Noise',
                          sprintf('../images/built/con%03.fnoi%03.f_img.png',50,(threshold+pedValue)*100),
                          sprintf('../images/built/con%03.fnoi%03.f_img.png',(threshold+pedValue)*100,50)))
```


Let's start by looking at the discrimination functions in the main data. First let's do some adjusting to get mainmean to have some rounded text (for plotting onto the ggplot)

```{r}
mainmean = main %>% 
  group_by(taskf,pedestal,cuesf,dualf) %>% 
  summarise(mu=mean(threshold),sd=sd(threshold))
mainmean = mainmean %>% mutate(muround=round(mu,2))
```


```{r}
# pdf('../analysis/s300/figures/discFuncs.pdf')
g = ggplot(data=mainmean,aes(pedestal,mu)) +
  geom_line(data=mainmean,aes(pedestal,mu,color=dualf,linetype=cuesf)) +
  geom_errorbar(data=mainmean,aes(pedestal,mu,ymin=mu-sd,ymax=mu+sd,color=dualf,linetype=cuesf),width=.1) +
#   geom_text(data=mainmean,aes(label=mainmean$muround,x=mainmean$pedestal+.2,y=mainmean$mu)) +
  facet_grid(.~taskf) +
  theme_bw()
# dev.off()
```

TESTING IMAGE DISPLAY
```{r}
# library(png)
# library(grid)
# img = readPNG('../images/built/con100noi050_img.png')
# img = rasterGrob(img,interpolate=TRUE)
# qplot(1:10,1:10,geom="blank") +
#   annotation_custom(g,xmin=2,xmax=4,ymin=2,ymax=4)
```

Now let's look at the discrimination functions in the peripheral data

```{r plot peripheral barplot}
# pdf('../analysis/s300/figures/discFuncsGender.pdf')
ggplot() +
  geom_point(data=per,aes(taskf,y=threshold,color=taskf),size=5) +
  geom_errorbar(data=permean,aes(taskf,mu,ymin=mu-sd,ymax=mu+sd),size=.5,width=.3) +
  geom_point(data=permean,aes(taskf,mu),size=6) +
  theme_bw()

contrasts(per$taskf) = cbind(c(2,-1,-1),c(0,1,-1))
per %>% lm(data=.,threshold ~ taskf) %>% summary()
# dev.off()
```

Now let's normalize all of our data by the mean values.

```{r}
perNorm = per %>%
  mutate(single = permean[1,2]$mu) %>%
  mutate(nThresh = threshold / single)
mainNorm = main %>%
  mutate(nThresh = threshold / pedValue)
```

```{r}
pedFrame = pedFrame %>%
  mutate(rpedValue = round(pedValue,2))
mainNormMean = mainNorm %>%
  group_by(taskf,pedValue,cuesf,dualf) %>% 
  summarise(mu=mean(nThresh),sd=sd(nThresh))
```

```{r}
ggplot() +
  geom_line(data=mainNormMean,aes(pedValue,mu,color=dualf,linetype=cuesf)) +
  geom_errorbar(data=mainNormMean,aes(pedValue,mu,ymin=mu-sd,ymax=mu+sd,color=dualf,linetype=cuesf),width=.03) +
#   geom_text(data=mainmean,aes(label=mainmean$muround,x=mainmean$pedestal+.2,y=mainmean$mu)) +
  facet_grid(.~taskf) +
  theme_bw()
```

```{r}
perNormMean = perNorm %>%
  group_by(taskf) %>%
  summarise(mu=mean(nThresh),sd=sd(nThresh))
ggplot() +
  geom_point(data=perNorm,aes(taskf,y=nThresh,color=taskf),size=5) +
  geom_errorbar(data=perNormMean,aes(taskf,mu,ymin=mu-sd,ymax=mu+sd),size=.5,width=.3) +
  geom_point(data=perNormMean,aes(taskf,mu),size=6) +
  theme_bw()
```
